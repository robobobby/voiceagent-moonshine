<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceAgent — Streaming</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --border: #2a2a3a;
    --text: #e8e8f0;
    --text-dim: #888899;
    --accent: #6366f1;
    --success: #22c55e;
    --error: #ef4444;
    --warn: #f59e0b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
  }
  h1 { font-size: 1.1rem; font-weight: 400; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.5rem; }
  h1 span { color: var(--accent); }
  .subtitle { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 2rem; }

  .live-text {
    width: 100%; max-width: 700px;
    min-height: 120px;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1.4rem;
    line-height: 1.6;
    color: var(--text);
    margin-bottom: 1.5rem;
    transition: border-color 0.3s;
    word-wrap: break-word;
  }
  .live-text.active { border-color: var(--accent); }
  .live-text .cursor {
    display: inline-block;
    width: 2px;
    height: 1.2em;
    background: var(--accent);
    vertical-align: text-bottom;
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  .controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .mic-btn {
    width: 72px; height: 72px;
    border-radius: 50%;
    background: var(--surface);
    border: 2px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  .mic-btn:hover { border-color: var(--accent); }
  .mic-btn.recording { border-color: var(--error); box-shadow: 0 0 20px rgba(239,68,68,0.3); animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  .mic-btn svg { width: 32px; height: 32px; fill: var(--text-dim); transition: fill 0.3s; }
  .mic-btn.recording svg { fill: var(--error); }

  .status { font-size: 0.7rem; color: var(--text-dim); }
  .status.ok::before { content: '● '; color: var(--success); }
  .status.err::before { content: '● '; color: var(--error); }

  .history {
    width: 100%; max-width: 700px;
    max-height: 40vh;
    overflow-y: auto;
  }
  .history-entry {
    padding: 0.8rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
    line-height: 1.5;
  }
  .history-entry .meta { font-size: 0.6rem; color: var(--text-dim); margin-bottom: 0.2rem; }

  .visualizer { width: 100%; max-width: 700px; height: 32px; margin-bottom: 1rem; }
  .visualizer canvas { width: 100%; height: 100%; border-radius: 4px; }
</style>
</head>
<body>
  <h1><span>Voice</span>Agent</h1>
  <div class="subtitle">streaming • real-time transcription</div>

  <div class="visualizer"><canvas id="viz"></canvas></div>

  <div class="live-text" id="liveText">
    <span id="liveContent"></span><span class="cursor" id="cursor" style="display:none"></span>
  </div>

  <div class="controls">
    <button class="mic-btn" id="mic" title="Click to start/stop">
      <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>
    <div class="status err" id="status">connecting...</div>
  </div>

  <div class="history" id="history"></div>

<script>
const WS_URL = 'ws://localhost:8765';
const SAMPLE_RATE = 16000;

let ws, audioCtx, mediaStream, analyser, processor, animFrame;
let streaming = false;

function connect() {
  ws = new WebSocket(WS_URL);
  ws.binaryType = 'arraybuffer';
  ws.onopen = () => { status('ok', 'ready — moonshine streaming'); };
  ws.onclose = () => { status('err', 'disconnected'); setTimeout(connect, 2000); };
  ws.onmessage = (e) => {
    const d = JSON.parse(e.data);
    if (d.type === 'partial_transcript') {
      document.getElementById('liveContent').textContent = d.text;
    } else if (d.type === 'final_transcript') {
      finalize(d.text);
    } else if (d.type === 'stream_started') {
      document.getElementById('liveContent').textContent = '';
      document.getElementById('cursor').style.display = 'inline-block';
    }
  };
}

function status(cls, txt) {
  const el = document.getElementById('status');
  el.className = 'status ' + cls;
  el.textContent = txt;
}

function finalize(text) {
  document.getElementById('cursor').style.display = 'none';
  if (text.trim()) {
    const h = document.getElementById('history');
    const d = document.createElement('div');
    d.className = 'history-entry';
    d.innerHTML = `<div class="meta">${new Date().toLocaleTimeString()}</div><div>${text}</div>`;
    h.prepend(d);
  }
  document.getElementById('liveContent').textContent = '';
}

async function initAudio() {
  audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
  mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: SAMPLE_RATE, channelCount: 1, echoCancellation: true, noiseSuppression: true } });
  const source = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);

  processor = audioCtx.createScriptProcessor(4096, 1, 1);
  source.connect(processor);
  processor.connect(audioCtx.destination);
  processor.onaudioprocess = (e) => {
    if (streaming && ws && ws.readyState === 1) {
      const pcm = e.inputBuffer.getChannelData(0);
      ws.send(new Float32Array(pcm).buffer);
    }
  };
  drawViz();
}

function drawViz() {
  const c = document.getElementById('viz');
  const ctx = c.getContext('2d');
  c.width = c.offsetWidth * 2;
  c.height = c.offsetHeight * 2;
  (function draw() {
    animFrame = requestAnimationFrame(draw);
    if (!analyser) return;
    const d = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(d);
    ctx.fillStyle = '#14141f';
    ctx.fillRect(0, 0, c.width, c.height);
    const bw = (c.width / d.length) * 2;
    let x = 0;
    for (let i = 0; i < d.length; i++) {
      const h = (d[i] / 255) * c.height;
      ctx.fillStyle = streaming ? `rgba(239,68,68,${0.3+d[i]/255*0.7})` : `rgba(99,102,241,${0.15+d[i]/255*0.4})`;
      ctx.fillRect(x, c.height - h, bw - 1, h);
      x += bw;
    }
  })();
}

async function toggleStream() {
  if (!audioCtx) await initAudio();
  const btn = document.getElementById('mic');
  if (!streaming) {
    streaming = true;
    btn.classList.add('recording');
    status('ok', 'streaming...');
    ws.send(JSON.stringify({ type: 'start_stream' }));
  } else {
    streaming = false;
    btn.classList.remove('recording');
    status('ok', 'ready — moonshine streaming');
    ws.send(JSON.stringify({ type: 'stop_stream' }));
  }
}

document.getElementById('mic').addEventListener('click', toggleStream);
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && !e.repeat) { e.preventDefault(); toggleStream(); }
});

connect();
</script>
</body>
</html>
